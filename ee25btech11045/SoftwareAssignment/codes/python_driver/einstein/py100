import os
import numpy as np
from PIL import Image
import matplotlib.pyplot as plt

# Load the image using the full path
file_path = "/home/navya/EE1030-2025-Project-Submissions/ee25btech11045/SoftwareAssignment/codes/python_driver/einstein/einstein.jpg"
einstein = Image.open(file_path)

# Display the image
plt.figure(figsize=(12,6))
plt.imshow(einstein)
plt.title('Original image')

# Get file size and shape
file_size = os.path.getsize(file_path)
print(f"Size: {np.round(file_size/1024)} KB")
print(f"Shape: {np.array(einstein).shape}")

einstein_array = np.array(einstein, dtype=np.uint8)
 
# Converting to grayscale
einstein_gray = np.mean(einstein_array, axis=2).astype(np.uint8)
print(f"Shape of Grayscale einstein: {np.shape(einstein_gray)}")

# Displaying grayscale image
plt.figure(figsize=(12,6))
plt.imshow(einstein_gray, cmap='gray')
plt.title('Grayscale image')

# Saving the grayscale image
file_path_gray = "/home/navya/EE1030-2025-Project-Submissions/ee25btech11045/SoftwareAssignment/codes/python_driver/einstein/gray_einstein.jpg"
Image.fromarray(einstein_gray).save(file_path_gray)
file_size_einstein_gray = os.path.getsize(file_path_gray)
print(f"Size grayscale einstein: {np.round(file_size_einstein_gray/1024)} KB")

plt.show()

# SVD
U, s, Vt = np.linalg.svd(einstein_gray, full_matrices=False)
print(f'U = {np.shape(U)}')
print(f's = {np.shape(s)}')
print(f'V = {np.shape(Vt)}')

S = np.diag(s)
gray_reconstructed_3 = U @ S @ Vt 

# Visualizing
plt.figure(figsize=(18,10))

plt.subplot(2,3,4)
plt.title('Original Gray scale', fontsize=18)
plt.imshow(U, cmap='coolwarm')

plt.subplot(2,3,1)
plt.title('U', fontsize=18)
plt.imshow(U, cmap='coolwarm')

plt.subplot(2,3,2)
plt.title('$\\Sigma$', fontsize=18)
plt.imshow(S, cmap='coolwarm')

plt.subplot(2,3,5)
plt.title('gray_reconstructed_3', fontsize=18)
plt.imshow(gray_reconstructed_3, cmap='gray')
plt.axis('off')

plt.tight_layout()
plt.show()

# Plot singular values
plt.figure(figsize=(12,6))
plt.subplot(1,2,1)
plt.plot(s, 'ro', markerfacecolor='w')
plt.title('Singular Values')
plt.show()

# Reconstruct using top-k singular values
S_k = np.zeros((np.shape(U)[1], np.shape(Vt)[0]))
no_k = 100

for i in range(no_k):
    S_k[i, i] = s[i]

gray_reconstructed_3 = np.clip(U @ S_k @ Vt, 0, 255).astype(np.uint8)

# Saving reconstructed image
file_path_gray_reconstructed_3 = "/home/navya/EE1030-2025-Project-Submissions/ee25btech11045/SoftwareAssignment/codes/python_driver/einstein/gray_reconstructed_3.jpg"
Image.fromarray(gray_reconstructed_3).save(file_path_gray_reconstructed_3)
file_size_gray_reconstructed_3 = os.path.getsize(file_path_gray_reconstructed_3)
print(f"Size gray_reconstructed_3: {np.round(file_size_gray_reconstructed_3/1024)} KB")
print(f"Size grayscale einstein: {np.round(file_size_einstein_gray/1024)} KB")

# Display grayscale and reconstructed side by side
einstein_grayscale = Image.open(file_path_gray)
plt.figure(figsize=(15,8))

plt.subplot(1,2,1)
plt.imshow(einstein_grayscale, cmap='gray')
plt.title('Original Grayscale')

plt.subplot(1,2,2)
plt.imshow(gray_reconstructed_3, cmap='gray')
plt.title('Reconstructed image_3')

plt.show()
